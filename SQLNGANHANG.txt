//chuyen nhan vien
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_ChuyenNhanVien]    Script Date: 21/12/2021 10:00:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_ChuyenNhanVien]
@MANV NCHAR(10), @MACN NCHAR(10), @MANEW NCHAR(10)
AS
DECLARE @LGNAME VARCHAR(50)
DECLARE @USERNAME VARCHAR(50)
SET XACT_ABORT ON;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
BEGIN TRY
	BEGIN DISTRIBUTED TRANSACTION

		INSERT INTO LINK.NGANHANG.dbo.NhanVien (MANV, HO, TEN, DIACHI, PHAI, SODT, MACN, TRANGTHAIXOA)
		SELECT MANV = @MANEW, HO, TEN, DIACHI, PHAI, SODT, MACN = @MACN, TRANGTHAIXOA
		FROM dbo.NhanVien
		WHERE MANV = @MANV

		IF EXISTS(SELECT 1 FROM NhanVien NV
				WHERE NV.MANV = @MANV AND				
				(EXISTS(SELECT GR.MAGD FROM GD_GOIRUT GR WHERE GR.MANV = NV.MANV) 
					OR EXISTS(SELECT CT.MAGD FROM GD_CHUYENTIEN CT WHERE CT.MANV = NV.MANV)))
						
		BEGIN 
			UPDATE dbo.NhanVien
			SET TrangThaiXoa = 1
			WHERE MANV = @MANV;
		END
		ELSE
		BEGIN
			DELETE FROM NhanVien Where NhanVien.MANV = @MANV
		END
		COMMIT TRANSACTION;
		IF EXISTS(SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(@MANV AS NVARCHAR))
		BEGIN
		SET @LGNAME = CAST((SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(@MANV AS NVARCHAR)) AS VARCHAR(50))
		SET @USERNAME = CAST(@MANV AS VARCHAR(50))
		EXEC SP_DROPUSER @USERNAME;
		EXEC SP_DROPLOGIN @LGNAME;
		END
END TRY
BEGIN CATCH
	IF (@@TRANCOUNT > 0)
	BEGIN
		ROLLBACK TRANSACTION
		RAISERROR('Lỗi khi chuyển nhân viên. Vui lòng kiểm tra.', 16, 1)
	END
END CATCH
//chuyen tien
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_GiaoDichChuyenTien]    Script Date: 21/12/2021 10:01:57 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_GiaoDichChuyenTien]
@SOTK_NHAN NCHAR(9), @SOTK_CHUYEN NCHAR(9), @SOTIEN MONEY
AS
SET XACT_ABORT ON
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
BEGIN TRANSACTION
BEGIN TRY
	IF EXISTS(SELECT TK.SOTK FROM TaiKhoan TK WHERE TK.SOTK = @SOTK_CHUYEN)
		BEGIN
			UPDATE dbo.TaiKhoan
			SET SODU = SODU - @SOTIEN
			WHERE SOTK = @SOTK_CHUYEN
		END
	IF EXISTS(SELECT TK.SOTK FROM TaiKhoan TK WHERE TK.SOTK = @SOTK_NHAN)
		BEGIN
			UPDATE dbo.TaiKhoan
			SET SODU = SODU + @SOTIEN
			WHERE SOTK = @SOTK_NHAN
		END
	COMMIT TRANSACTION
END TRY
BEGIN CATCH
	IF (@@TRANCOUNT > 0)
	BEGIN
		ROLLBACK TRANSACTION
		RAISERROR('Lỗi khi chuyển tiền. Vui lòng kiểm tra.', 16, 1)
	END
END CATCH
//rut tien
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_GiaoDichGoiRut]    Script Date: 21/12/2021 10:02:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_GiaoDichGoiRut]
@TYPE NCHAR(2), @SOTIEN MONEY, @SOTK NCHAR(9)
AS
SET XACT_ABORT ON
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
BEGIN TRANSACTION
BEGIN TRY
	IF(@TYPE = 'GT')
		BEGIN
			IF EXISTS(SELECT TK.SOTK FROM TaiKhoan TK WHERE TK.SOTK = @SOTK)
				BEGIN
					UPDATE dbo.TaiKhoan
					SET SODU = SODU + @SOTIEN
					WHERE SOTK = @SOTK
				END
		END
	IF(@TYPE = 'RT')
		BEGIN
			IF EXISTS(SELECT TK.SOTK FROM TaiKhoan TK WHERE TK.SOTK = @SOTK)
				BEGIN
					UPDATE dbo.TaiKhoan
					SET SODU = SODU - @SOTIEN
					WHERE SOTK = @SOTK
				END
		END
	COMMIT TRANSACTION
END TRY
BEGIN CATCH
	IF (@@TRANCOUNT > 0)
	BEGIN
		ROLLBACK TRANSACTION
		RAISERROR('Lỗi khi gởi rút tiền. Vui lòng kiểm tra.', 16, 1)
	END
END CATCH
//kiem tra giao dich

USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_KiemTraGiaoDich]    Script Date: 21/12/2021 10:03:49 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_KiemTraGiaoDich]
@SOTK NCHAR(9)
AS
BEGIN
	IF EXISTS(SELECT TK.SOTK FROM TaiKhoan TK WHERE TK.SOTK = @SOTK AND (EXISTS(SELECT GR.SOTK FROM GD_GOIRUT GR WHERE GR.SOTK = @SOTK)) OR EXISTS(SELECT CT.SOTK_CHUYEN FROM GD_CHUYENTIEN CT WHERE CT.SOTK_NHAN = @SOTK OR CT.SOTK_CHUYEN = @SOTK))
	BEGIN
		RETURN 1
	END
	ELSE IF EXISTS(SELECT TK.SOTK FROM TaiKhoan TK WHERE TK.SOTK = @SOTK AND (EXISTS(SELECT GR.SOTK FROM LINK0.NGANHANG.dbo.GD_GOIRUT GR WHERE GR.SOTK = @SOTK)) OR EXISTS(SELECT CT.SOTK_CHUYEN FROM LINK0.NGANHANG.dbo.GD_CHUYENTIEN CT WHERE CT.SOTK_NHAN = @SOTK OR CT.SOTK_CHUYEN = @SOTK))
	BEGIN
		RETURN 2
	END
	RETURN 0
END
//kiem tra login
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_KiemTraLogin]    Script Date: 21/12/2021 10:04:04 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_KiemTraLogin]
@MANV NCHAR(10)
AS
BEGIN
  IF EXISTS(SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(@MANV AS NVARCHAR))
		BEGIN
			return 1
		END
		RETURN 0
END
//kiem tra so du

USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_KiemTraSoDu]    Script Date: 21/12/2021 10:04:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_KiemTraSoDu]
@SOTK NCHAR(9), @SOTIEN MONEY
AS
BEGIN
	IF EXISTS(SELECT TK.SOTK FROM TaiKhoan TK WHERE TK.SOTK = @SOTK AND TK.SODU - @SOTIEN >= 50000)
	BEGIN
		RETURN 1
	END
	RETURN 0
END
//lay thong tin

USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_Lay_Thong_Tin_NV_Tu_Login]    Script Date: 21/12/2021 10:04:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_Lay_Thong_Tin_NV_Tu_Login]
@TENLOGIN NVARCHAR( 100)
AS
DECLARE @UID INT
DECLARE @MANV NVARCHAR(100)
SELECT @UID= uid , @MANV= NAME FROM sys.sysusers 
  WHERE sid = SUSER_SID(@TENLOGIN)

SELECT MAGV= @MANV, 
       HOTEN = (SELECT HO+ ' '+TEN FROM dbo.NhanVien WHERE MANV=@MANV ), 
       TENNHOM=NAME
  FROM sys.sysusers
    WHERE UID = (SELECT groupuid FROM sys.sysmembers WHERE memberuid=@uid)
//Liet ke cac tai khoan
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_LietKeCacTaiKhoanMoTrongMotKhoangThoiGianCuaChiNhanh]    Script Date: 21/12/2021 10:05:27 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_LietKeCacTaiKhoanMoTrongMotKhoangThoiGianCuaChiNhanh]
	@NGAYBD DATETIME,
	@NGAYKT DATETIME
AS
BEGIN
	SELECT SOTK, CMND, SODU, NGAYMOTK
	FROM TaiKhoan
	WHERE NGAYMOTK BETWEEN @NGAYBD AND @NGAYKT
END
//Liet ke khach hang
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_LietKeKhachHangTheoTungChiNhanh]    Script Date: 21/12/2021 10:05:47 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_LietKeKhachHangTheoTungChiNhanh]
AS
BEGIN
	SELECT HO, TEN, CMND, NGAYCAP, SODT, DIACHI
	FROM KhachHang
	ORDER BY HO, TEN
END
//sao ke giao dich
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaoKeGiaoDichMotTaiKhoanTrongMotKhoangThoiGian]    Script Date: 21/12/2021 10:05:59 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_SaoKeGiaoDichMotTaiKhoanTrongMotKhoangThoiGian]
@SOTAIKHOAN NVARCHAR(9), @NGAYBD DATETIME, @NGAYKT DATETIME
AS
DECLARE @SOTIENBANDAU MONEY, @SODU MONEY
DECLARE @tab table(SODUDAU MONEY, NGAYGD DATETIME, LOAIGD NVARCHAR(2), SOTIEN MONEY, SODUSAU MONEY)

SELECT @SODU = SODU FROM TaiKhoan TK WHERE TK.SOTK = @SOTAIKHOAN

SELECT @SOTIENBANDAU = @SODU + SUM(CASE WHEN GD.LOAIGD = 'RT' THEN GD.SOTIEN WHEN GD.LOAIGD = 'GT' THEN -GD.SOTIEN
WHEN GD.SOTK = @SOTAIKHOAN THEN -GD.SOTIEN ELSE GD.SOTIEN END)
FROM LINK0.NGANHANG.dbo.TaiKhoan TK, (SELECT NGAYGD, SOTIEN, LOAIGD='CT', SOTK = CT.SOTK_NHAN  FROM LINK0.NGANHANG.dbo.GD_CHUYENTIEN CT WHERE CT.SOTK_NHAN = @SOTAIKHOAN OR CT.SOTK_CHUYEN = @SOTAIKHOAN
UNION SELECT NGAYGD, SOTIEN, LOAIGD, SOTK FROM LINK0.NGANHANG.dbo.GD_GOIRUT WHERE GD_GOIRUT.SOTK = @SOTAIKHOAN) GD
Where TK.SOTK = @SOTAIKHOAN

DECLARE @SODUDAU MONEY, @NGAYGD DATETIME, @LOAIGD NVARCHAR(2), @SOTIEN MONEY, @SODUSAU MONEY, @TK_NHAN NVARCHAR(9), @TEMP MONEY
DECLARE cursorTK CURSOR 
FOR SELECT @SOTIENBANDAU, GD.NGAYGD, GD.LOAIGD, GD.SOTIEN, GD.SOTK, SUM(CASE WHEN GD.LOAIGD = 'RT' THEN @SOTIENBANDAU - GD.SOTIEN WHEN GD.LOAIGD = 'GT' THEN @SOTIENBANDAU + GD.SOTIEN
	WHEN GD.SOTK = @SOTAIKHOAN THEN @SOTIENBANDAU + GD.SOTIEN ELSE @SOTIENBANDAU - GD.SOTIEN END) AS SODUSAU
	FROM LINK0.NGANHANG.dbo.TaiKhoan TK, (SELECT NGAYGD, SOTIEN, LOAIGD='CT', SOTK = CT.SOTK_NHAN  FROM LINK0.NGANHANG.dbo.GD_CHUYENTIEN CT WHERE CT.SOTK_NHAN = @SOTAIKHOAN OR CT.SOTK_CHUYEN = @SOTAIKHOAN
	UNION SELECT NGAYGD, SOTIEN, LOAIGD, SOTK FROM LINK0.NGANHANG.dbo.GD_GOIRUT WHERE GD_GOIRUT.SOTK = @SOTAIKHOAN) GD
	Where TK.SOTK = @SOTAIKHOAN --AND (GD.NGAYGD BETWEEN @NGAYBD AND @NGAYKT)
	GROUP BY SODU, GD.LOAIGD, GD.NGAYGD, GD.SOTIEN, GD.SOTK
	ORDER BY GD.NGAYGD

OPEN cursorTK
FETCH NEXT FROM cursorTK
      INTO @SODUDAU, @NGAYGD, @LOAIGD, @SOTIEN, @TK_NHAN, @SODUSAU
WHILE @@FETCH_STATUS = 0
BEGIN 
	SET @TEMP = @SODUSAU   
	INSERT INTO @tab(SODUDAU, NGAYGD, LOAIGD, SOTIEN, SODUSAU)
	VALUES (@SODUDAU, @NGAYGD, @LOAIGD, @SOTIEN, @SODUSAU) 
	FETCH NEXT FROM cursorTK
      INTO @SODUDAU, @NGAYGD, @LOAIGD, @SOTIEN, @TK_NHAN, @SODUSAU
	
	SET @SODUDAU = @TEMP
		IF(@LOAIGD = 'RT')
			BEGIN
				SET @SODUSAU = @TEMP - @SOTIEN
			END
		ELSE IF(@LOAIGD = 'GT')
			BEGIN
				SET @SODUSAU = @TEMP + @SOTIEN
			END
		ELSE IF(@TK_NHAN = @SOTAIKHOAN)
			BEGIN
				SET @SODUSAU = @TEMP + @SOTIEN
			END
		ELSE
			BEGIN
				SET @SODUSAU = @TEMP - @SOTIEN
			END
END
SELECT SODUDAU, NGAYGD,(CASE WHEN LOAIGD = 'CT' THEN N'CHUYỂN TIỀN' WHEN LOAIGD = 'GT' THEN N'GỞI TIỀN' ELSE N'RÚT TIỀN' END) AS LOAIGD, SOTIEN, SODUSAU
FROM @tab t 
WHERE t.NGAYGD BETWEEN @NGAYBD AND @NGAYKT
CLOSE cursorTK  
DEALLOCATE cursorTK  
//tao tai khoan
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_TaoTaiKhoan]    Script Date: 21/12/2021 10:06:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_TaoTaiKhoan]
	@LGNAME VARCHAR(50),
	@PASS VARCHAR(50),
	@USERNAME VARCHAR(50),
	@ROLE VARCHAR(50)
AS
BEGIN
  DECLARE @RET INT
  EXEC @RET= SP_ADDLOGIN @LGNAME, @PASS,'NGANHANG'                     

  IF (@RET =1)  -- LOGIN NAME BI TRUNG
     RETURN 1

  EXEC @RET= SP_GRANTDBACCESS @LGNAME, @USERNAME
  IF (@RET =1)  -- USER  NAME BI TRUNG
  BEGIN
       EXEC SP_DROPLOGIN @LGNAME
       RETURN 2
  END
  EXEC sp_addrolemember @ROLE, @USERNAME

  IF @ROLE= 'NGANHANG' 
	BEGIN
		EXEC sp_addsrvrolemember @LGNAME, 'SecurityAdmin'
		EXEC sp_addsrvrolemember @LGNAME, 'ProcessAdmin'
	END

  IF @ROLE= 'CHINHANH'
	BEGIN 
		EXEC sp_addsrvrolemember @LGNAME, 'SecurityAdmin'
		EXEC sp_addsrvrolemember @LGNAME, 'ProcessAdmin'
	END
END
//tao tk chi nhanh khac
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_TaoTaiKhoanKhacChiNhanh]    Script Date: 21/12/2021 10:06:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_TaoTaiKhoanKhacChiNhanh]
@SOTK NCHAR(10), @CMND NCHAR(9), @SODU MONEY,@MACN NCHAR(10), @NGAYMO DATETIME
AS
SET XACT_ABORT ON;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
BEGIN TRANSACTION
BEGIN TRY
		INSERT INTO LINK.NGANHANG.dbo.TaiKhoan (SOTK, CMND, SODU, MACN, NGAYMOTK)
		VALUES(@SOTK, @CMND, @SODU, @MACN, @NGAYMO)

		COMMIT TRANSACTION
END TRY
BEGIN CATCH
	IF (@@TRANCOUNT > 0)
	BEGIN
		ROLLBACK TRANSACTION
		RAISERROR('Lỗi tạo tài khoản. Vui lòng kiểm tra.', 16, 1)
	END
END CATCH
//tim kh
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_TimKH]    Script Date: 21/12/2021 10:07:00 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_TimKH]
	@X NCHAR(10)
AS
BEGIN
	IF EXISTS(SELECT CMND FROM dbo.KhachHang WHERE dbo.KhachHang.CMND = @X)
		RETURN 1; 
	ELSE IF EXISTS(SELECT CMND FROM LINK3.NGANHANG.dbo.KhachHang AS KH WHERE KH.CMND = @X)
		RETURN 2; 
	ELSE 
		RETURN 0; 
END
//tim nv
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_TimNV]    Script Date: 21/12/2021 10:07:10 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_TimNV]
	@X NCHAR(10)
AS
BEGIN
	IF EXISTS(SELECT MANV FROM dbo.NhanVien WHERE dbo.NhanVien.MANV = @X)
		RETURN 1; 
	ELSE IF EXISTS(SELECT MANV FROM LINK0.NGANHANG.dbo.NhanVien AS NV WHERE NV.MANV = @X)
		RETURN 1; 
	ELSE 
		RETURN 0;
END
//tim soTK
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_TimSoTK]    Script Date: 21/12/2021 10:07:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_TimSoTK]
	@X NCHAR(9)
AS
BEGIN
	IF EXISTS(SELECT TK.SOTK FROM dbo.TaiKhoan TK WHERE TK.SOTK = @X)
		RETURN 1; 
	ELSE 
		RETURN 0;
END
xoa login
USE [NGANHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_XoaLogin]    Script Date: 21/12/2021 10:07:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_XoaLogin]
@USERNAME VARCHAR(50)
AS
DECLARE @LGNAME VARCHAR(50)
IF EXISTS (SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(@USERNAME AS NVARCHAR))
BEGIN
	SET @LGNAME = CAST((SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(@USERNAME AS NVARCHAR)) AS VARCHAR(50))
	EXEC SP_DROPUSER @USERNAME
	EXEC SP_DROPLOGIN @LGNAME
END
